version: "3.9"

services:
    db:
        image: postgres:16-alpine
        restart: unless-stopped
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-gimnasio}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-1234}
            POSTGRES_DB: ${POSTGRES_DB:-gimnasio_db}
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-gimnasio}"]
            interval: 10s
            timeout: 5s
            retries: 5

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        restart: unless-stopped
        ports:
            - "3000:3000"
        environment:
            PORT: ${PORT:-3000}
            DATABASE_URL: ${DATABASE_URL:-postgresql://gimnasio:1234@db:5432/gimnasio_db}
            JWT_SECRET: ${JWT_SECRET:-change-this-secret-in-production}
            JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-15m}
            REFRESH_JWT_EXPIRES_IN: ${REFRESH_JWT_EXPIRES_IN:-7d}
            NODE_ENV: ${NODE_ENV:-production}
            CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost}
        depends_on:
            db:
                condition: service_healthy
        volumes:
            - ./backend/resources:/app/resources

    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
            args:
                VITE_API_URL: ${VITE_API_URL:-http://localhost:3000}
        restart: unless-stopped
        ports:
            - "80:80"
        depends_on:
            - backend

volumes:
    postgres_data:
